<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Reisekostenabrechnung online erstellen - Schnell & Einfach | Kostenlos nutzen</title>
    <meta name="description" content="✓ Kostenlose Reisekostenabrechnung online erstellen ✓ Automatische Berechnung der Verpflegungspauschalen ✓ PDF-Export für nur 0,59€ ✓ Nach § 9 Abs. 4a EStG und BRKG">
    <meta name="keywords" content="Reisekostenabrechnung, Reisekosten, Verpflegungspauschale, Fahrtkosten, Übernachtungskosten, § 9 Abs. 4a EStG, BRKG, Dienstreise, Geschäftsreise">
    <meta name="author" content="Reisekostenabrechnung Tool">
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/3135/3135673.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/3135/3135673.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/3135/3135673.png">
    <meta name="theme-color" content="#1E40AF">
    
    <!-- Social Media Meta Tags mit Emojis -->
    <meta property="og:title" content="📊 Reisekostenabrechnung online erstellen - Schnell & Einfach">
    <meta property="og:description" content="💡 Erstellen Sie Ihre Reisekostenabrechnung online - professionell, schnell und zuverlässig. ✅ Automatische Berechnung ✅ Sofort nutzbar">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ihre-domain.de">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="📊 Reisekostenabrechnung online erstellen">
    <meta name="twitter:description" content="💡 Professionelle Reisekostenabrechnung online erstellen - mit automatischer Berechnung der Verpflegungspauschalen.">
    <link rel="canonical" href="https://ihre-domain.de">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=IHRE_PAYPAL_CLIENT_ID&currency=EUR"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js Worker initialisieren
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .summary-card {
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
        }
        input:checked + .toggle-dot {
            transform: translateX(100%);
        }
        .receipt-required::after {
            content: "*";
            color: red;
            margin-left: 2px;
        }
        .signature-line {
            border-top: 1px solid #000;
            width: 200px;
            margin-top: 40px;
        }
        #payment-form {
            max-width: 500px;
            margin: 0 auto;
        }
        .StripeElement {
            box-sizing: border-box;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 1px 3px 0 #e6ebf1;
            -webkit-transition: box-shadow 150ms ease;
            transition: box-shadow 150ms ease;
        }
        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }
        .StripeElement--invalid {
            border-color: #fa755a;
        }
        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
        #payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        #payment-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        .pdf-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
        }
        .pdf-preview-content {
            position: relative;
            max-width: 1000px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .pdf-preview-close {
            transition: all 0.3s ease;
        }
        .pdf-preview-close:hover {
            transform: scale(1.1);
        }
        #pdf-viewer {
            max-width: 100%;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
            margin-top: 20px;
            background: #fff;
            box-shadow: 0 4px 24px rgba(0,0,0,0.10);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }
        #pdf-viewer canvas {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin: 0 auto;
            display: block;
            width: 595px !important; /* DIN A4 Breite px @ 72dpi */
            height: 842px !important; /* DIN A4 Höhe px @ 72dpi */
            max-width: 100%;
            max-height: 100%;
        }
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 60px;
            color: rgba(0, 0, 0, 0.1);
            pointer-events: none;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-icon {
            color: #3B82F6;
            cursor: help;
            margin-left: 4px;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #1E40AF;
            color: white;
            text-align: left;
            padding: 8px 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            width: 250px;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1E40AF transparent transparent transparent;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                font-size: 12pt;
            }
            
            .container {
                max-width: none;
                padding: 0;
                margin: 0;
            }
            
            .custom-shadow {
                box-shadow: none;
            }
            
            .bg-white {
                background: white !important;
            }
            
            .bg-gray-50 {
                background: white !important;
            }
            
            button, 
            .add-cost-btn,
            #payment-modal,
            .pdf-preview,
            .tooltip {
                display: none !important;
            }
            
            input, select {
                border: none;
                padding: 0;
                background: transparent;
            }
            
            input[type="checkbox"] {
                -webkit-appearance: checkbox;
                appearance: checkbox;
                opacity: 1;
            }
            
            #results-container {
                display: block !important;
            }
            
            #summary-placeholder {
                display: none !important;
            }
            
            .grid {
                display: block;
            }
            
            .mb-6 {
                margin-bottom: 1.5rem;
            }
            
            h2, h3 {
                break-after: avoid;
            }
            
            table {
                break-inside: avoid;
            }
            
            .page-break {
                break-before: page;
            }
        }
        
        /* Emoji Styles */
        .feature-emoji {
            font-size: 1.5em;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Main Tool -->
        <div class="bg-white rounded-xl p-6 custom-shadow mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                📊 Jetzt Reisekostenabrechnung erstellen
            </h2>
            <p class="text-gray-600 mb-6">
                💼 Nutzen Sie unseren professionellen Reisekostenrechner und erstellen Sie Ihre Abrechnung in wenigen Minuten. Der PDF-Export kostet nur 0,89€.
            </p>
            
            <!-- Feature Cards mit Emojis -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="flex items-center">
                        <span class="feature-emoji">⚡</span>
                        <span>Schnelle Berechnung</span>
                    </p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="flex items-center">
                        <span class="feature-emoji">🔒</span>
                        <span>Sichere Verarbeitung</span>
                    </p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="flex items-center">
                        <span class="feature-emoji">📱</span>
                        <span>Auf allen Geräten nutzbar</span>
                    </p>
                </div>
            </div>

            <!-- Input Form -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Input Form -->
                <div class="lg:col-span-2 bg-white rounded-xl p-6 custom-shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Reisedaten erfassen</h2>
                    
                    <!-- Basic Travel Info -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-info-circle text-blue-500 mr-2"></i> Grundinformationen
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Reisezweck</label>
                                <input type="text" id="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Reisender</label>
                                <input type="text" id="traveler" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Abteilung</label>
                                <input type="text" id="department" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kostenträger</label>
                                <input type="text" id="cost-center" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reisezeitraum -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-calendar-alt text-blue-500 mr-2"></i> Reisezeitraum
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Startdatum/-zeit</label>
                                <input type="datetime-local" id="start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateTravelExpenses()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Enddatum/-zeit</label>
                                <input type="datetime-local" id="end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateTravelExpenses()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Verpflegungspauschalen -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-utensils text-blue-500 mr-2"></i> 
                            Verpflegungspauschalen
                            <span class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">
                                    Die Verpflegungspauschale wird bei gestellten Mahlzeiten gekürzt:
                                    - Frühstück: 20% (5,60€)
                                    - Mittagessen: 40% (11,20€)
                                    - Abendessen: 40% (11,20€)
                                </span>
                            </span>
                        </h3>
                        <div id="daily-allowances" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Datum</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pauschale</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Frühstück (-5,60€)</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Mittagessen (-11,20€)</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Abendessen (-11,20€)</th>
                                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">Summe</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <!-- Wird dynamisch gefüllt -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transportation -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-car text-blue-500 mr-2"></i> 
                                    Transportmittel
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">
                                            Bei Nutzung eines privaten PKW werden 0,30€ pro gefahrenem Kilometer erstattet. 
                                            Für andere Transportmittel geben Sie bitte die tatsächlichen Kosten an.
                                        </span>
                                    </span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transportart</label>
                                <select id="transport-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="car">Privater PKW</option>
                                    <option value="train">Bahn</option>
                                    <option value="plane">Flugzeug</option>
                                    <option value="other">Andere</option>
                                </select>
                            </div>
                            <div id="distance-container">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entfernung (km)</label>
                                <input type="number" id="distance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="cost-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1 receipt-required">Kosten (€)</label>
                                <input type="number" step="0.01" id="transport-cost" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Costs -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-receipt text-blue-500 mr-2"></i> 
                                    Zusätzliche Kosten
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">
                                            Hier können Sie weitere Kosten wie Übernachtungen, Parkgebühren oder Taxi erfassen. 
                                            Bitte bewahren Sie die entsprechenden Belege auf.
                                        </span>
                                    </span>
                        </h3>
                        <div class="space-y-4" id="additional-costs">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kostenart</label>
                                    <select class="cost-type w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="accommodation">Übernachtung</option>
                                        <option value="parking">Parkgebühren</option>
                                        <option value="taxi">Taxi</option>
                                        <option value="tickets">Tickets</option>
                                        <option value="other">Sonstiges</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 receipt-required">Betrag (€)</label>
                                    <input type="number" step="0.01" class="cost-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="add-cost-btn w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                        Hinzufügen
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="costs-list" class="mt-4 space-y-2"></div>
                    </div>
                    
                    <!-- Signature Fields -->
                    <div class="mt-8">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-signature text-blue-500 mr-2"></i> Unterschriftsfelder
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name Antragsteller</label>
                                <input type="text" id="applicant-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name Genehmiger</label>
                                <input type="text" id="approver-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculate Button -->
                    <div class="mt-8">
                        <button id="calculate-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-md text-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Berechnen <i class="fas fa-calculator ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl p-6 custom-shadow sticky top-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Zusammenfassung</h2>
                        
                        <div id="summary-placeholder" class="text-center py-8 text-gray-500">
                            <i class="fas fa-file-alt text-4xl mb-3"></i>
                            <p>Bitte geben Sie Ihre Reisedaten ein und klicken Sie auf "Berechnen", um eine detaillierte Aufstellung Ihrer Reisekosten zu erhalten.</p>
                        </div>
                        
                        <div id="results-container" class="hidden">
                            <!-- Reiseinformationen -->
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Reiseinformationen</h3>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm"><span class="font-medium">Zweck:</span> <span id="summary-purpose"></span></p>
                                    <p class="text-sm"><span class="font-medium">Reisender:</span> <span id="summary-traveler"></span></p>
                                    <p class="text-sm"><span class="font-medium">Abteilung:</span> <span id="summary-department"></span></p>
                                    <p class="text-sm"><span class="font-medium">Kostenträger:</span> <span id="summary-cost-center"></span></p>
                                    <p class="text-sm"><span class="font-medium">Zeitraum:</span> <span id="summary-dates"></span></p>
                                    <p class="text-sm"><span class="font-medium">Transport:</span> <span id="summary-transport"></span></p>
                                </div>
                            </div>
                            
                            <!-- Fahrtkosten -->
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Fahrtkosten</h3>
                                <div id="transportation-costs" class="bg-gray-50 p-3 rounded-lg"></div>
                            </div>
                            
                            <!-- Zusätzliche Kosten -->
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Zusätzliche Kosten</h3>
                                <div id="additional-costs-summary" class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-500" id="no-additional-costs">Keine zusätzlichen Kosten erfasst</p>
                                </div>
                            </div>
                            
                            <!-- Verpflegungspauschalen -->
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Verpflegungspauschalen</h3>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm">Summe Verpflegungspauschalen:</span>
                                        <span class="font-medium" id="summary-allowances">0,00 €</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gesamtbetrag -->
                            <div class="mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Gesamtbetrag</h3>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-lg font-bold text-blue-800" id="total-amount">0,00 €</p>
                                </div>
                            </div>
                            
                            <!-- Export Buttons -->
                            <div class="flex justify-end mt-4 space-x-4">
                                <button onclick="showPdfPreview()" 
                                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded flex items-center">
                                    Vorschau <i class="fas fa-eye ml-2"></i>
                                </button>
                                <button onclick="window.open('https://buy.stripe.com/5kAdQW9Fg8Ey6UU9AB', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center">
                                    Als PDF exportieren (0,89€) <i class="fas fa-file-pdf ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEO Content -->
        <div class="bg-white rounded-xl p-6 custom-shadow mb-8">
            <div class="prose max-w-none">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">✨ Vorteile unseres Reisekostenrechners</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="flex items-center">
                            <span class="feature-emoji">🧮</span>
                            <span>Automatische Berechnung</span>
                        </p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="flex items-center">
                            <span class="feature-emoji">🛡️</span>
                            <span>DSGVO-konform</span>
                        </p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="flex items-center">
                            <span class="feature-emoji">📄</span>
                            <span>Professioneller Export</span>
                        </p>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">So funktioniert's</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-blue-600 font-bold">1</span>
                        </div>
                        <p class="text-gray-700">Reisedaten eingeben</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-blue-600 font-bold">2</span>
                        </div>
                        <p class="text-gray-700">Kosten erfassen</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-blue-600 font-bold">3</span>
                        </div>
                        <p class="text-gray-700">Berechnen lassen</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-blue-600 font-bold">4</span>
                        </div>
                        <p class="text-gray-700">PDF exportieren</p>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">Wichtige Informationen</h2>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Verpflegungsmehraufwand</h3>
                            <p class="text-gray-600">14€ pro Tag</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Übernachtungskosten</h3>
                            <p class="text-gray-600">20€ pro Nacht</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Fahrtkosten</h3>
                            <p class="text-gray-600">0,30€ pro Kilometer (PKW)</p>
                        </div>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">FAQ</h2>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Wie werden gestellte Mahlzeiten berücksichtigt?</h3>
                        <p class="text-gray-600">Bei gestellten Mahlzeiten werden die Verpflegungspauschalen entsprechend gekürzt: Frühstück 20%, Mittag- und Abendessen je 40%.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Kann ich die Abrechnung auch für mehrere Tage erstellen?</h3>
                        <p class="text-gray-600">Ja, unser Tool unterstützt die Erfassung von Reisen über mehrere Tage mit automatischer Berechnung der Tagespauschalen.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Wie sicher sind meine Daten?</h3>
                        <p class="text-gray-600">Ihre Daten werden ausschließlich lokal in Ihrem Browser verarbeitet und nicht an unseren Server übertragen. Die PDF-Erstellung erfolgt erst nach Ihrer Bestätigung.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Vorschau Modal -->
    <div class="pdf-preview" id="pdf-preview">
        <div class="pdf-preview-content">
            <button type="button" class="pdf-preview-close" onclick="closePdfPreview()">×</button>
            <div class="watermark">VORSCHAU</div>
            <div id="pdf-viewer"></div>
        </div>
    </div>

    <!-- Rechtliche Hinweise und Haftungsausschluss -->
    <div class="bg-gray-50 p-6 rounded-lg mt-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Rechtliche Hinweise</h2>
        
        <!-- Haftungsausschluss -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <p class="text-gray-700 mb-4">
                <strong>Haftungsausschluss:</strong> Alle Angaben und Berechnungen erfolgen ohne Gewähr. Die Nutzung des Tools ersetzt keine steuerliche oder rechtliche Beratung. Für die Richtigkeit und Vollständigkeit der Daten haftet der Nutzer selbst.
            </p>
        </div>
        
        <!-- Pauschalen Info -->
        <div class="bg-blue-50 p-4 rounded-lg mb-6">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Aktuelle Pauschalen</h3>
            <div class="flex items-center mb-4">
                <label class="mr-2">Abrechnung erfolgt mit den Pauschalen von:</label>
                <select id="year-selector" class="border rounded px-2 py-1">
                    <option value="2024">2024</option>
                    <option value="2025" disabled>2025 (noch nicht verfügbar)</option>
                </select>
            </div>
            <p class="text-gray-600">
                Die Pauschalen werden jährlich vom Bundesfinanzministerium angepasst. Diese Anwendung nutzt die Werte für das Jahr 2024. Eine Aktualisierung für 2025 erfolgt automatisch, sobald die neuen Sätze veröffentlicht sind.
            </p>
        </div>
        
        <!-- Belegnachweis Info -->
        <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Wichtiger Hinweis zu Belegen</h3>
            <p class="text-gray-600">
                Bitte beachten Sie: Für die Einreichung Ihrer Reisekostenabrechnung müssen Sie alle relevanten Belege (Hotelrechnungen, Fahrkarten, Tankquittungen etc.) im Original beifügen oder für steuerliche Zwecke aufbewahren. Diese Anwendung erstellt lediglich die Berechnung - die Belegsammlung liegt in Ihrer Verantwortung.
            </p>
        </div>
    </div>

    <!-- Cookie Banner -->
    <div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4 z-50 hidden">
        <div class="container mx-auto max-w-6xl">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="mb-4 md:mb-0">
                    <p class="text-gray-700">
                        Wir verwenden Cookies, um Ihnen das beste Nutzererlebnis zu bieten. 
                        <a href="#" onclick="showPrivacyModal()" class="text-blue-600 hover:text-blue-800">Mehr erfahren</a>
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="acceptCookies()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Akzeptieren
                    </button>
                    <button onclick="declineCookies()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                        Ablehnen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer mit Impressum-Link -->
    <footer class="bg-gray-50 py-4 mt-8">
        <div class="container mx-auto max-w-6xl text-center">
            <div class="flex justify-center space-x-4 text-sm text-gray-600">
                <a href="#" onclick="showPrivacyModal()" class="hover:text-blue-600">Datenschutz</a>
                <span>|</span>
                <a href="#" onclick="showImpressumModal()" class="hover:text-blue-600">Impressum</a>
            </div>
        </div>
    </footer>

    <!-- Impressum & Datenschutz Modal -->
    <div id="legal-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Impressum</h2>
                <button onclick="closeLegalModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content" class="space-y-4">
                <!-- Wird dynamisch gefüllt -->
            </div>
        </div>
    </div>

    <script>
        // Cookie Banner Funktionen
        function showCookieBanner() {
            if (!localStorage.getItem('cookieConsent')) {
                document.getElementById('cookie-banner').classList.remove('hidden');
            }
        }

        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'accepted');
            document.getElementById('cookie-banner').classList.add('hidden');
        }

        function declineCookies() {
            localStorage.setItem('cookieConsent', 'declined');
            document.getElementById('cookie-banner').classList.add('hidden');
        }

        // Modal Funktionen
        function showImpressumModal() {
            const modal = document.getElementById('legal-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            title.textContent = 'Impressum';
            content.innerHTML = `
                <div class="space-y-4">
                    <p class="text-gray-700">
                        <strong>Angaben gemäß § 5 TMG:</strong><br>
                        Peter Horvath<br>
                        E-Mail: phhmburg@gmx.de<br>
                        Telefon: 0178 6974815
                    </p>
                    <p class="text-gray-700">
                        <strong>Verantwortlich für den Inhalt nach § 55 Abs. 2 RStV:</strong><br>
                        Peter Horvath
                    </p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function showPrivacyModal() {
            const modal = document.getElementById('legal-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            title.textContent = 'Datenschutzerklärung';
            content.innerHTML = `
                <div class="space-y-4">
                    <p class="text-gray-700">
                        <strong>Datenschutz auf einen Blick</strong>
                    </p>
                    <p class="text-gray-700">
                        Diese Anwendung verarbeitet alle Daten ausschließlich lokal in Ihrem Browser. Es werden keine personenbezogenen Daten an unseren Server übertragen. Die PDF-Erstellung erfolgt erst nach Ihrer Bestätigung und Zahlung.
                    </p>
                    <p class="text-gray-700">
                        <strong>Cookies</strong><br>
                        Wir verwenden nur technisch notwendige Cookies für die Funktionalität der Anwendung. Diese werden nicht für Tracking-Zwecke verwendet.
                    </p>
                    <p class="text-gray-700">
                        <strong>Zahlungsabwicklung</strong><br>
                        Für die Zahlungsabwicklung nutzen wir den Dienst Stripe. Die Datenschutzerklärung von Stripe finden Sie unter: <a href="https://stripe.com/de/privacy" class="text-blue-600 hover:text-blue-800" target="_blank">https://stripe.com/de/privacy</a>
                    </p>
                    <p class="text-gray-700">
                        <strong>Ihre Rechte</strong><br>
                        Sie haben jederzeit das Recht auf Auskunft über die zu Ihrer Person gespeicherten Daten. Da wir keine personenbezogenen Daten speichern, ist eine Auskunft nicht erforderlich.
                    </p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeLegalModal() {
            document.getElementById('legal-modal').classList.add('hidden');
        }

        // Cookie Banner beim Laden anzeigen
        document.addEventListener('DOMContentLoaded', showCookieBanner);

        // Modal schließen wenn außerhalb geklickt wird
        document.getElementById('legal-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLegalModal();
            }
        });

        // --- BERECHNUNGS- UND ZUSAMMENFASSUNGSLOGIK ---
        let additionalCosts = [];
        let mealSelections = {};

        // Kostenliste aktualisieren
        function updateCostsList() {
            const costsList = document.getElementById('costs-list');
            costsList.innerHTML = '';
            if (additionalCosts.length === 0) return;
            additionalCosts.forEach(cost => {
                const costElement = document.createElement('div');
                costElement.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
                costElement.innerHTML = `
                    <div>
                        <span class="text-sm font-medium">${getCostTypeName(cost.type)}</span>
                        <span class="text-sm text-gray-600 ml-2">${cost.amount.toFixed(2)} €</span>
                    </div>
                    <button class="delete-cost-btn text-red-500 hover:text-red-700" data-id="${cost.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                costsList.appendChild(costElement);
            });
            document.querySelectorAll('.delete-cost-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const costId = parseInt(this.getAttribute('data-id'));
                    additionalCosts = additionalCosts.filter(cost => cost.id !== costId);
                    updateCostsList();
                });
            });
        }
        function getCostTypeName(type) {
            const types = {
                'accommodation': 'Übernachtung',
                'parking': 'Parkgebühren',
                'taxi': 'Taxi',
                'tickets': 'Tickets',
                'other': 'Sonstiges'
            };
            return types[type] || type;
        }
        // Event Listener für Kosten hinzufügen
        if (document.querySelector('.add-cost-btn')) {
            document.querySelector('.add-cost-btn').addEventListener('click', function() {
                const costType = document.querySelector('.cost-type').value;
                const costAmount = parseFloat(document.querySelector('.cost-amount').value);
                if (isNaN(costAmount) || costAmount <= 0) {
                    alert('Bitte geben Sie einen gültigen Betrag ein');
                    return;
                }
                const costId = Date.now();
                additionalCosts.push({ id: costId, type: costType, amount: costAmount });
                updateCostsList();
                document.querySelector('.cost-amount').value = '';
            });
        }
        // Berechnung der Reisekosten
        function calculateTravelExpenses() {
            // Grunddaten abrufen
            const purpose = document.getElementById('purpose').value;
            const traveler = document.getElementById('traveler').value;
            const department = document.getElementById('department').value;
            const costCenter = document.getElementById('cost-center').value;
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            document.getElementById('summary-purpose').textContent = purpose;
            document.getElementById('summary-traveler').textContent = traveler;
            document.getElementById('summary-department').textContent = department;
            document.getElementById('summary-cost-center').textContent = costCenter;
            document.getElementById('summary-dates').textContent = `${startDate.toLocaleDateString('de-DE')} bis ${endDate.toLocaleDateString('de-DE')}`;
            if (!startDate || !endDate || startDate > endDate) {
                alert('Bitte geben Sie ein gültiges Start- und Enddatum ein.');
                return;
            }
            // --- MAHLZEITEN-CHECKBOXEN SPEICHERN ---
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            for (let i = 0; i < days; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateKey = currentDate.toISOString().slice(0,10);
                mealSelections[dateKey] = {
                    breakfast: document.getElementById(`day-${i}-breakfast`)?.checked || false,
                    lunch: document.getElementById(`day-${i}-lunch`)?.checked || false,
                    dinner: document.getElementById(`day-${i}-dinner`)?.checked || false
                };
            }
            // Tägliche Verpflegungspauschalen berechnen
            const dailyAllowances = document.getElementById('daily-allowances');
            dailyAllowances.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Datum</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pauschale</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Frühstück (-5,60€)</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Mittagessen (-11,20€)</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">Abendessen (-11,20€)</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">Summe</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;
            for (let i = 0; i < days; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateStr = currentDate.toLocaleDateString('de-DE', {
                    weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit'
                });
                const dateKey = currentDate.toISOString().slice(0,10);
                let dailyAmount = 28.00;
                if (i === 0 || i === days - 1) dailyAmount = 14.00;
                // --- MAHLZEITEN AUS SPEICHER LESEN ---
                const breakfastChecked = mealSelections[dateKey]?.breakfast || false;
                const lunchChecked = mealSelections[dateKey]?.lunch || false;
                const dinnerChecked = mealSelections[dateKey]?.dinner || false;
                dailyAllowances.querySelector('tbody').innerHTML += `
                    <tr class="bg-white">
                        <td class="px-4 py-3 text-sm text-gray-900">${dateStr}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${dailyAmount.toFixed(2)} €</td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" id="day-${i}-breakfast" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="calculateDailyAmount('day-${i}')" ${breakfastChecked ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" id="day-${i}-lunch" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="calculateDailyAmount('day-${i}')" ${lunchChecked ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" id="day-${i}-dinner" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="calculateDailyAmount('day-${i}')" ${dinnerChecked ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 text-right text-sm font-medium" id="day-${i}-total">${dailyAmount.toFixed(2)} €</td>
                    </tr>
                `;
            }
            dailyAllowances.innerHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg mt-4">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Summe Verpflegungspauschalen:</span>
                        <span class="font-medium text-lg" id="total-daily-allowance">0,00 €</span>
                    </div>
                </div>
            `;
            // Transportkosten berechnen
            const transportType = document.getElementById('transport-type').value;
            const transportCosts = document.getElementById('transportation-costs');
            let transportAmount = 0;
            let transportDescription = '';
            if (transportType === 'car') {
                const distance = parseFloat(document.getElementById('distance').value) || 0;
                transportAmount = distance * 0.30;
                transportDescription = `PKW (${distance} km × 0,30€)`;
            } else {
                transportAmount = parseFloat(document.getElementById('transport-cost').value) || 0;
                transportDescription = `${getCostTypeName(transportType)}`;
            }
            transportCosts.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-sm">${transportDescription}</span>
                    <span class="font-medium tabular-nums">${transportAmount.toFixed(2)}€</span>
                </div>
            `;
            // Zusätzliche Kosten berechnen
            const additionalCostsSummary = document.getElementById('additional-costs-summary');
            let totalAdditionalCosts = 0;
            if (additionalCosts.length > 0) {
                additionalCostsSummary.innerHTML = '';
                additionalCosts.forEach(cost => {
                    totalAdditionalCosts += cost.amount;
                    const costElement = document.createElement('div');
                    costElement.className = 'flex justify-between items-center mb-2';
                    costElement.innerHTML = `
                        <span class="text-sm">${getCostTypeName(cost.type)}</span>
                        <span class="font-medium tabular-nums">${cost.amount.toFixed(2)}€</span>
                    `;
                    additionalCostsSummary.appendChild(costElement);
                });
            } else {
                additionalCostsSummary.innerHTML = '<p class="text-sm text-gray-500" id="no-additional-costs">Keine zusätzlichen Kosten erfasst</p>';
            }
            // Gesamtbetrag berechnen und anzeigen
            const totalAmount = transportAmount + totalAdditionalCosts;
            document.getElementById('total-amount').textContent = `${totalAmount.toFixed(2)}€`;
            // Ergebnisse anzeigen
            document.getElementById('summary-placeholder').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            // Nach dem Rendern: Tagespauschalen und Gesamtsumme berechnen
            for (let i = 0; i < days; i++) {
                calculateDailyAmount(`day-${i}`);
            }
        }
        // Tagespauschale berechnen
        function calculateDailyAmount(dayId) {
            const breakfastChecked = document.getElementById(`${dayId}-breakfast`).checked;
            const lunchChecked = document.getElementById(`${dayId}-lunch`).checked;
            const dinnerChecked = document.getElementById(`${dayId}-dinner`).checked;
            const dayIndex = parseInt(dayId.split('-')[1]);
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const baseAmount = (dayIndex === 0 || dayIndex === days - 1) ? 14.00 : 28.00;
            let deductions = 0;
            if (breakfastChecked) deductions += 5.60;
            if (lunchChecked) deductions += 11.20;
            if (dinnerChecked) deductions += 11.20;
            const finalAmount = Math.max(0, baseAmount - deductions);
            document.getElementById(`${dayId}-total`).textContent = `${finalAmount.toFixed(2)} €`;
            updateTotalDailyAllowance();
        }
        function updateTotalDailyAllowance() {
            let total = 0;
            const dailyTotals = document.querySelectorAll('[id$="-total"]');
            dailyTotals.forEach(element => {
                const amountText = element.textContent;
                const amount = parseFloat(amountText.replace('€', '').replace(',', '.').trim());
                if (!isNaN(amount)) total += amount;
            });
            // Wert immer korrekt anzeigen
            document.getElementById('total-daily-allowance').textContent = `${total.toFixed(2)} €`;
            document.getElementById('summary-allowances').textContent = `${total.toFixed(2)} €`;
            updateTotalAmount();
        }
        function updateTotalAmount() {
            const allowancesText = document.getElementById('summary-allowances').textContent;
            const allowancesAmount = parseFloat(allowancesText.replace('€', '').trim()) || 0;
            const transportText = document.getElementById('transportation-costs').textContent;
            const transportAmount = parseFloat(transportText.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
            const additionalTotal = additionalCosts.reduce((sum, cost) => sum + cost.amount, 0);
            const total = allowancesAmount + transportAmount + additionalTotal;
            document.getElementById('total-amount').textContent = `${total.toFixed(2)}€`;
        }
        // Event Listener für Berechnen-Button
        if (document.getElementById('calculate-btn')) {
            document.getElementById('calculate-btn').addEventListener('click', function(e) {
                e.preventDefault();
                calculateTravelExpenses();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('payment') === 'success') {
                // PDF automatisch generieren und herunterladen
                if (typeof generateAndDownloadPDF === 'function') {
                    setTimeout(() => {
                        generateAndDownloadPDF();
                    }, 500); // kleiner Delay, damit alles geladen ist
                } else {
                    alert('PDF-Download ist aktuell nicht möglich. Bitte klicken Sie auf "Vorschau" oder "Als PDF exportieren".');
                }
            }
        });

        // Umschalten der Transportfelder je nach Auswahl
        if (document.getElementById('transport-type')) {
            document.getElementById('transport-type').addEventListener('change', function() {
                const transportType = this.value;
                const distanceContainer = document.getElementById('distance-container');
                const costContainer = document.getElementById('cost-container');
                if (transportType === 'car') {
                    distanceContainer.classList.remove('hidden');
                    costContainer.classList.add('hidden');
                } else {
                    distanceContainer.classList.add('hidden');
                    costContainer.classList.remove('hidden');
                }
            });
        }

        // PDF-Generierung und Vorschau
        function formatEuro(amount) {
            // Geschütztes Leerzeichen vor €
            return amount.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '\u202f€';
        }

        function generatePDF() {
            const doc = new window.jspdf.jsPDF({unit: 'mm', format: 'a4'});
            // Layout-Parameter
            const margin = 20;
            const pageWidth = 210;
            const contentWidth = pageWidth - 2 * margin;
            const lightGray = [245, 245, 245];
            const headerGray = [230, 230, 230];
            const borderGray = [204, 204, 204];
            const blue = [0, 51, 153]; // #003399
            const altRow = [249, 249, 249]; // Alternierende Zeilenfarbe
            doc.setFont('helvetica', '');
            // Rahmen um das Formular
            doc.setDrawColor(...borderGray);
            doc.setLineWidth(0.7);
            doc.roundedRect(margin-2, margin-2, contentWidth+4, 257, 6, 6, 'S');
            // Titel
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text('Reisekostenabrechnung', pageWidth/2, margin+10, {align: 'center'});
            doc.setFont(undefined, 'normal');
            // Dünne Linie unter Titel
            doc.setDrawColor(200,200,200);
            doc.setLineWidth(0.5);
            doc.line(margin, margin+14, pageWidth-margin, margin+14);
            // Kopfbereich
            let y = margin+20;
            doc.setFillColor(...headerGray);
            doc.roundedRect(margin, y, contentWidth, 34, 6, 6, 'F');
            doc.setFontSize(12);
            doc.setTextColor(60,60,60);
            let traveler = document.getElementById('traveler').value || '';
            let department = document.getElementById('department').value || '';
            let costCenter = document.getElementById('cost-center').value || '';
            let purpose = document.getElementById('purpose').value || '';
            let startDate = document.getElementById('start-date').value ? new Date(document.getElementById('start-date').value) : null;
            let endDate = document.getElementById('end-date').value ? new Date(document.getElementById('end-date').value) : null;
            let transportType = document.getElementById('transport-type').options[document.getElementById('transport-type').selectedIndex].text;
            let applicantName = document.getElementById('applicant-name').value || '';
            // Zeitraum-Formatierung
            let zeitraum = '';
            if (startDate && endDate) {
                zeitraum = `${startDate.toLocaleDateString('de-DE')}, ${startDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})} bis ${endDate.toLocaleDateString('de-DE')}, ${endDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}`;
            }
            let kopfzeilen = [
                `Name: ${traveler}`,
                `Abteilung: ${department}`,
                `Kostenträger: ${costCenter}`,
                `Reisezweck: ${purpose}`,
                `Zeitraum: ${zeitraum}`,
                `Transportmittel: ${transportType}`
            ];
            let yKopf = y+8;
            kopfzeilen.forEach(line => {
                doc.text(line, margin+6, yKopf);
                yKopf += 4.8;
            });
            y = y+34+16; // Abstand zur ersten Tabelle
            // Tabelle 1: Verpflegungspauschalen
            let dailyRows = [];
            let totalAllowances = 0;
            if (startDate && endDate) {
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                for (let i = 0; i < days; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateStr = currentDate.toLocaleDateString('de-DE', {weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit'});
                    const baseAmount = (i === 0 || i === days - 1) ? 14.00 : 28.00;
                    const breakfast = document.getElementById(`day-${i}-breakfast`)?.checked;
                    const lunch = document.getElementById(`day-${i}-lunch`)?.checked;
                    const dinner = document.getElementById(`day-${i}-dinner`)?.checked;
                    let deductions = 0;
                    if (breakfast) deductions += 5.60;
                    if (lunch) deductions += 11.20;
                    if (dinner) deductions += 11.20;
                    const finalAmount = Math.max(0, baseAmount - deductions);
                    totalAllowances += finalAmount;
                    let deductionText = [];
                    if (breakfast) deductionText.push('Frühstück');
                    if (lunch) deductionText.push('Mittagessen');
                    if (dinner) deductionText.push('Abendessen');
                    dailyRows.push([
                        dateStr,
                        formatEuro(baseAmount),
                        deductionText.length ? deductionText.join(', ') : '–',
                        formatEuro(finalAmount)
                    ]);
                }
                doc.autoTable({
                    startY: y,
                    head: [['Datum', 'Pauschale', 'Kürzungen (ggf.)', 'Summe']],
                    body: dailyRows,
                    theme: 'grid',
                    styles: {fontSize: 12, cellPadding: {top: 4, right: 8, bottom: 4, left: 8}, lineColor: borderGray, lineWidth: 0.3, valign: 'middle', halign: 'left'},
                    headStyles: {fontSize: 14, fillColor: lightGray, textColor: 60, fontStyle: 'bold'},
                    alternateRowStyles: {fillColor: altRow},
                    columnStyles: {1: {halign: 'right'}, 2: {halign: 'center'}, 3: {halign: 'right'}},
                    margin: {left: margin, right: margin},
                    tableWidth: contentWidth,
                    didDrawCell: function (data) {
                        if (data.section === 'body' && data.column.index === 3) {
                            doc.setFont(undefined, 'bold');
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 16;
            }
            // Tabelle 2: Einzelpositionen
            let transport = document.getElementById('transportation-costs').textContent || '0,00 €';
            let additionalRows = [];
            const additionalCostsSummary = document.getElementById('additional-costs-summary');
            if (additionalCostsSummary) {
                const rows = additionalCostsSummary.querySelectorAll('div.flex');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('span');
                    if (cells.length === 2) {
                        additionalRows.push([cells[0].textContent, cells[1].textContent]);
                    }
                });
            }
            let overnight = additionalRows.filter(r => r[0].includes('Übernachtung')).reduce((sum, r) => sum + parseFloat((r[1]||'0').replace(',','.')), 0);
            let transportVal = parseFloat((transport.match(/[\d,.]+/)||['0'])[0].replace(',','.'));
            let posRows = [
                ['Fahrtkosten', transportType, formatEuro(transportVal)],
                ['Verpflegungspauschalen', '', formatEuro(totalAllowances)],
                ['Übernachtungskosten', '', formatEuro(overnight)]
            ];
            posRows = posRows.concat(
                additionalRows.filter(r => !r[0].includes('Übernachtung')).map(r => ['Nebenkosten', r[0], r[1]])
            );
            // Gesamtbetrag korrekt berechnen
            let total = transportVal + totalAllowances + overnight;
            additionalRows.filter(r => !r[0].includes('Übernachtung')).forEach(r => {
                total += parseFloat((r[1]||'0').replace(',','.'));
            });
            doc.autoTable({
                startY: y,
                head: [['Position', 'Beschreibung', 'Betrag (\u202f€)']],
                body: posRows,
                theme: 'grid',
                styles: {fontSize: 12, cellPadding: {top: 4, right: 8, bottom: 4, left: 8}, lineColor: borderGray, lineWidth: 0.3, valign: 'middle', halign: 'left'},
                headStyles: {fontSize: 14, fillColor: lightGray, textColor: 60, fontStyle: 'bold'},
                alternateRowStyles: {fillColor: altRow},
                columnStyles: {2: {halign: 'right'}},
                margin: {left: margin, right: margin},
                tableWidth: contentWidth,
                didDrawCell: function (data) {
                    if (data.section === 'body' && data.column.index === 2) {
                        doc.setFont(undefined, 'bold');
                    }
                }
            });
            y = doc.lastAutoTable.finalY + 18;
            // Gesamtbetrag
            doc.setFontSize(16);
            doc.setTextColor(...blue);
            doc.setFont(undefined, 'bold');
            doc.text(`Gesamtbetrag: ${formatEuro(total)}`, margin, y);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0,0,0);
            y += 24;
            // Abschlussbereich
            doc.setFontSize(12);
            doc.text('Ort, Datum:', margin+5, y);
            doc.line(margin+30, y+0.5, margin+85, y+0.5);
            y += 10;
            doc.text('Unterschrift:', margin+5, y);
            doc.line(margin+30, y+0.5, margin+85, y+0.5);
            y += 10;
            if(applicantName) doc.text(`Antragsteller: ${applicantName}`, margin+5, y);
            return doc;
        }

        function generateAndDownloadPDF() {
            const doc = generatePDF();
            let traveler = document.getElementById('traveler').value || 'Reisender';
            let startDate = document.getElementById('start-date').value ? new Date(document.getElementById('start-date').value) : null;
            let dateStr = startDate ? startDate.toLocaleDateString('de-DE') : '';
            const fileName = `Reisekostenabrechnung_${traveler.replace(/\s+/g, '_')}_${dateStr}.pdf`;
            doc.save(fileName);
        }

        function showPdfPreview() {
            const doc = generatePDF();
            const pdfData = doc.output('blob');
            const url = URL.createObjectURL(pdfData);
            const viewer = document.getElementById('pdf-viewer');
            viewer.innerHTML = '';
            const loadingTask = window.pdfjsLib.getDocument(url);
            loadingTask.promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    const scale = 1.2;
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    viewer.appendChild(canvas);
                    page.render({ canvasContext: context, viewport: viewport });
                });
            });
            document.getElementById('pdf-preview').style.display = 'block';
        }

        function closePdfPreview() {
            document.getElementById('pdf-preview').style.display = 'none';
        }

        // --- FORMULARDATEN SPEICHERN UND LADEN ---
        function saveFormDataToLocalStorage() {
            const data = {
                purpose: document.getElementById('purpose').value,
                traveler: document.getElementById('traveler').value,
                department: document.getElementById('department').value,
                costCenter: document.getElementById('cost-center').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                transportType: document.getElementById('transport-type').value,
                distance: document.getElementById('distance').value,
                transportCost: document.getElementById('transport-cost').value,
                applicantName: document.getElementById('applicant-name').value,
                approverName: document.getElementById('approver-name').value,
                additionalCosts: window.additionalCosts || []
            };
            localStorage.setItem('travelFormData', JSON.stringify(data));
        }

        function loadFormDataFromLocalStorage() {
            const data = JSON.parse(localStorage.getItem('travelFormData') || '{}');
            if (!data) return;
            if (data.purpose) document.getElementById('purpose').value = data.purpose;
            if (data.traveler) document.getElementById('traveler').value = data.traveler;
            if (data.department) document.getElementById('department').value = data.department;
            if (data.costCenter) document.getElementById('cost-center').value = data.costCenter;
            if (data.startDate) document.getElementById('start-date').value = data.startDate;
            if (data.endDate) document.getElementById('end-date').value = data.endDate;
            if (data.transportType) document.getElementById('transport-type').value = data.transportType;
            if (data.distance) document.getElementById('distance').value = data.distance;
            if (data.transportCost) document.getElementById('transport-cost').value = data.transportCost;
            if (data.applicantName) document.getElementById('applicant-name').value = data.applicantName;
            if (data.approverName) document.getElementById('approver-name').value = data.approverName;
            if (Array.isArray(data.additionalCosts)) {
                window.additionalCosts = data.additionalCosts;
                updateCostsList();
            }
            // Nach dem Laden: Zusammenfassung und Berechnung aktualisieren
            if (typeof calculateTravelExpenses === 'function') {
                calculateTravelExpenses();
            }
        }

        function clearFormDataFromLocalStorage() {
            localStorage.removeItem('travelFormData');
        }

        // Stripe-Button: Daten speichern
        const stripeBtn = document.querySelector('button[onclick*="stripe.com"]');
        if (stripeBtn) {
            stripeBtn.addEventListener('click', saveFormDataToLocalStorage);
        }

        // Nach Rückleitung: Daten laden und nach PDF-Download löschen
        if (window.location.search.includes('payment=success')) {
            loadFormDataFromLocalStorage();
            setTimeout(() => {
                if (typeof generateAndDownloadPDF === 'function') {
                    // Nochmals kleinen Timeout, damit alle DOM-Updates und Berechnungen abgeschlossen sind
                    setTimeout(() => {
                        generateAndDownloadPDF();
                        clearFormDataFromLocalStorage();
                    }, 500);
                }
            }, 500);
        }
    </script>
</body>
</html
